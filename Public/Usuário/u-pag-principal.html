<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>central do usuário</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="u-pag-principal.css" />
  </head>
  <body>
    <div class="d-flex">
      <!-- Sidebar -->
      <nav id="sidebar" class="bg-light">
        <div class="logo-container">
          <a href="/index.html">
            <img src="/IMGs/logotipo-jm.PNG" alt="Logo" class="logo" /></a>
        </div>

        <ul class="nav flex-column">
          <!-- Menu Item: Início -->
          <li class="nav-item">
            <a href="/index.html" class="nav-link py-3">
              <i class="fas fa-home"></i>
              <span class="nav-text">Home</span>
            </a>
          </li>

          <!-- Menu Item: Clientes -->
          <li class="nav-item">
            <a href="#" class="nav-link active py-3">
              <i class="fa-solid fa-user-tie"></i>
              <span class="nav-text">Usuário</span>
            </a>
          </li>

           <!-- Menu Item: Calendário -->
           <li class="nav-item">
            <a href="/Calendario/c-pag-principal.html" class="nav-link py-3">
              <i class="fa-regular fa-calendar"></i>
              <span class="nav-text">Calendário</span>
            </a>
          </li>

          <!-- Menu Item: Financeiro -->
          <li class="nav-item">
            <a href="/Financeiro/f-pag-principal.html" class="nav-link py-3">
              <i class="fa-solid fa-chart-pie"></i>
              <span class="nav-text">Financeiro</span>
            </a>
          </li>

          <!-- Menu Item: Relatórios -->
          <li class="nav-item">
            <a href="/Materiais/m-pag-principal.html" class="nav-link py-3">
              <i class="fa-solid fa-box-archive"></i>
              <span class="nav-text">Materiais</span>
            </a>
          </li>
        </ul>
      </nav>

      <!-- Main Content -->
      <div class="flex-grow-1 p-3">
        <h2 class="mb-4">Lista de Clientes</h2>
        <div class="container my-4">
                   
          <div class="accordion" id="accordionClientes">

            <!-- Botão para abrir o Modal cadastro -->
<button id="addClienteBtn" class="btn btn-primary  custom-btn" data-bs-toggle="modal" data-bs-target="#clienteModal">
  <i class="fas fa-plus"></i> Adicionar Cliente
</button> 
<!--------- Cadastro de Cliente --------->
<div class="modal fade" id="clienteModal" tabindex="-1" aria-labelledby="clienteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="clienteModalLabel">Cadastro de Cliente</h5>
        <button type="button" class="btn-close" style="color: rgb(166, 130, 138);" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formCadastroCliente" enctype="multipart/form-data">
          <div class="row">
            <!-- Coluna 1 -->
            <div class="col-md-6">
              <div class="mb-3">
                <label for="nomeCliente" class="form-label">Nome *</label>
                <input type="text" class="form-control" id="nomeCliente" name="nome" required>
              </div>
              <div class="mb-3">
                <label for="cpfCliente" class="form-label">CPF *</label>
                <input type="text" class="form-control" id="cpfCliente" name="cpf" required>
              </div>
              <div class="mb-3">
                <label for="emailCliente" class="form-label">Email *</label>
                <input type="email" class="form-control" id="emailCliente" name="email" required>
              </div>
              <div class="mb-3">
                <label for="dataNascimento" class="form-label">Data de Nascimento *</label>
                <input type="date" class="form-control" id="dataNascimento" name="dataNascimento" required>
              </div>
              <div class="mb-3">
                <label for="imagemCliente" class="form-label">Imagem do Cliente</label>
                <input type="file" class="form-control" id="imagemCliente" name="imagemCliente" accept="image/*">
              </div>
              <div id="imagemPreview" style="display: none;">
                <label class="form-label">Preview da Imagem</label>
                <img id="imagemPreviewImg" src="" alt="Imagem do Cliente" style="max-width: 100%; max-height: 200px;">
              </div>
            </div>
            <!-- Coluna 2 -->
            <div class="col-md-6">
              <div class="mb-3">
                <label for="parentescoCliente" class="form-label">Nome de Parentesco</label>
                <input type="text" class="form-control" id="parentescoCliente" name="parentescoNome">
              </div>
              <div class="mb-3">
                <label for="numeroParentesco" class="form-label">Número de Parentesco</label>
                <input type="text" class="form-control" id="numeroParentesco" name="parentescoNumero">
              </div>
              <div class="mb-3">
                <label for="remedioContinuo" class="form-label">Remédio Contínuo</label>
                <input type="checkbox" class="form-check-input" id="remedioContinuoCheckbox" name="remedioContinuo">
              </div>
              <div class="mb-3" id="remedioContinuoDetails" style="display: none;">
                <label for="nomeRemedio" class="form-label">Nome do Remédio</label>
                <input type="text" class="form-control" id="nomeRemedio" name="remedioNome">
              </div>
              <div class="mb-3" id="remedioContinuoDetails" style="display: none;">
                <label for="descricaoRemedio" class="form-label">Descrição do Remédio</label>
                <textarea class="form-control" id="descricaoRemedio" name="remedioDescricao"></textarea>
              </div>
              <div class="mb-3">
                <label for="problemasSaudeCheckbox" class="form-label">Problemas de Saúde</label>
                <input type="checkbox" class="form-check-input" id="problemasSaudeCheckbox" name="problemasSaude">
              </div>
              <div class="mb-3" id="problemasSaudeDetails" style="display: none;">
                <label for="problemasSaude" class="form-label">Descrição de Problemas de Saúde</label>
                <input type="text" class="form-control" id="problemasSaude" name="problemasSaudeDescricao">
              </div>
              <div class="mb-3">
                <label for="alergiaDoencaCheckbox" class="form-label">Alergia ou Doença</label>
                <input type="checkbox" class="form-check-input" id="alergiaDoencaCheckbox" name="alergiaDoenca">
              </div>
              <div class="mb-3" id="alergiaDoencaDetails" style="display: none;">
                <label for="alergiaDoenca" class="form-label">Descrição de Alergia ou Doença</label>
                <input type="text" class="form-control" id="alergiaDoenca" name="alergiaDoencaDescricao">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelarClienteBtn" >Cancelar</button>
        <button type="button" class="btn btn-primary" id="salvarClienteBtn">Salvar</button>
      </div>
    </div>
  </div>
</div>
            <!-- Cliente 1 -->
         
     <div class="accordion-item">
       <h2 class="accordion-header" id="headingOne">
         <button
           class="accordion-button"
           type="button"
           data-bs-toggle="collapse"
           data-bs-target="#collapseOne"
           aria-expanded="true"
           aria-controls="collapseOne"
         >
           <div class="d-flex justify-content-between align-items-center w-100">
             <div class="client-info"><strong>Nome:</strong> Nome do Cliente 1</div>
             <div class="client-info"><strong>Telefone:</strong> (11) 12345-6789</div>
             <div class="client-info"><strong>Email:</strong> cliente1@example.com</div>
           </div>
         </button>
       </h2>
       <div
         id="collapseOne"
         class="accordion-collapse collapse"
         aria-labelledby="headingOne"
         data-bs-parent="#accordionClientes"
       >
         <div class="accordion-body">
           <div class="row">
            
             <div class="col-md-4">
               <p><strong>Idade:</strong> 30 anos</p>
               <p><strong>CPF:</strong> 123.456.789-00</p>
               <p><strong>Nome de Parentesco:</strong> João Silva</p>
             </div>
             <div class="col-md-4">
               <p><strong>Número de Parentesco:</strong> (11) 98765-4321</p>
               <p><strong>Endereço:</strong> Rua Exemplo, 123 - Cidade, Estado</p>
               <p><strong>Remédio Contínuo:</strong> Sim - <em>Descrição do remédio...</em></p>
             </div>
             <div class="col-md-4">
               <p><strong>Problemas de Saúde:</strong> Não</p>
               <p><strong>Alergia ou Doença:</strong> Não</p>
             </div>
           </div>
         </div>
       </div>
     </div>
     
     <!-- Cliente 2 -->
     <div class="accordion-item">
       <h2 class="accordion-header" id="headingTwo">
         <button
           class="accordion-button collapsed"
           type="button"
           data-bs-toggle="collapse"
           data-bs-target="#collapseTwo"
           aria-expanded="false"
           aria-controls="collapseTwo"
         >
           <div class="d-flex justify-content-between align-items-center w-100">
             <div class="client-info"><strong>Nome:</strong> Nome do Cliente 2</div>
             <div class="client-info"><strong>Telefone:</strong> (21) 54321-6789</div>
             <div class="client-info"><strong>Email:</strong> cliente2@example.com</div>
           </div>
         </button>
       </h2>
  <div
    id="collapseTwo"
    class="accordion-collapse collapse"
    aria-labelledby="headingTwo"
    data-bs-parent="#accordionClientes"
  >
    <div class="accordion-body">
      <div class="row">
        
        <div class="col-md-4">
          <p><strong>Idade:</strong> 28 anos</p>
          <p><strong>CPF:</strong> 987.654.321-00</p>
          <p><strong>Nome de Parentesco:</strong> Maria Oliveira</p>
        </div>
        <div class="col-md-4">
          <p><strong>Número de Parentesco:</strong> (21) 87654-3210</p>
          <p><strong>Endereço:</strong> Avenida Exemplo, 456 - Cidade, Estado</p>
          <p><strong>Remédio Contínuo:</strong> Não</p>
        </div>
        <div class="col-md-4">
          <p><strong>Problemas de Saúde:</strong> Sim - <em>Descrição do problema...</em></p>
          <p><strong>Alergia ou Doença:</strong> Sim - <em>Descrição da alergia...</em></p>
        </div>
      </div>
    </div>
  </div>
</div>
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Obtém os checkboxes e os campos de detalhes
        const remedioContinuoCheckbox = document.getElementById("remedioContinuoCheckbox");
        const remedioContinuoDetails = document.getElementById("remedioContinuoDetails");
        const problemasSaudeCheckbox = document.getElementById("problemasSaudeCheckbox");
        const problemasSaudeDetails = document.getElementById("problemasSaudeDetails");
        const alergiaDoencaCheckbox = document.getElementById("alergiaDoencaCheckbox");
        const alergiaDoencaDetails = document.getElementById("alergiaDoencaDetails");
    
        // Manter estado dos checkboxes ao recarregar
        function manterEstadoCheckbox(checkbox, details) {
          checkbox.addEventListener("change", function () {
            details.style.display = this.checked ? "block" : "none";
            localStorage.setItem(checkbox.id, this.checked);
          });
    
          if (localStorage.getItem(checkbox.id) === "true") {
            checkbox.checked = true;
            details.style.display = "block";
          }
        }
    
        manterEstadoCheckbox(remedioContinuoCheckbox, remedioContinuoDetails);
        manterEstadoCheckbox(problemasSaudeCheckbox, problemasSaudeDetails);
        manterEstadoCheckbox(alergiaDoencaCheckbox, alergiaDoencaDetails);
    
        // Exibição do preview da imagem selecionada
        const imagemClienteInput = document.getElementById("imagemCliente");
        const imagemPreview = document.getElementById("imagemPreview");
        const imagemPreviewImg = document.getElementById("imagemPreviewImg");
    
        imagemClienteInput.addEventListener("change", function () {
          const file = imagemClienteInput.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              imagemPreviewImg.src = e.target.result;
              imagemPreview.style.display = "block";
            };
            reader.readAsDataURL(file);
          }
        });
    
        // Adicionar novo cliente ao accordion
        document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("formCadastroCliente");
  const salvarClienteBtn = document.getElementById("salvarClienteBtn");

  // Função para carregar os clientes e exibi-los no site
  async function carregarUsuarios() {
    try {
      const response = await fetch("/api/usuarios");
      if (!response.ok) throw new Error("Erro ao carregar usuários.");
      
      const usuarios = await response.json();
      const usuariosList = document.getElementById("accordionClientes");
      
      usuariosList.innerHTML = ""; // Limpa os usuários antes de adicionar novos
      
      usuarios.forEach(adicionarClienteAoAccordion);
    } catch (error) {
      console.error("Erro ao carregar usuários:", error);
    }
  }

  // Função para adicionar cliente na interface
  function adicionarClienteAoAccordion(usuario) {
    const id = usuario.id;
    const headingId = "heading" + id;
    const collapseId = "collapse" + id;

    const newAccordionItem = `
      <div class="accordion-item">
        <h2 class="accordion-header" id="${headingId}">
          <button class="accordion-button collapsed" type="button"
            data-bs-toggle="collapse" data-bs-target="#${collapseId}"
            aria-expanded="false" aria-controls="${collapseId}">
            <strong>${usuario.nome}</strong> - ${usuario.email} - ${usuario.cpf}
          </button>
        </h2>
        <div id="${collapseId}" class="accordion-collapse collapse"
          aria-labelledby="${headingId}" data-bs-parent="#accordionClientes">
          <div class="accordion-body">
            <p><strong>Data de Nascimento:</strong> ${usuario.dataNascimento}</p>
            <p><strong>Parentesco:</strong> ${usuario.parentescoNome} - ${usuario.parentescoNumero}</p>
            <img src="/Uploads/${usuario.imagemCliente}" alt="Imagem do Cliente" class="img-fluid" />
            <button class="btn btn-danger btn-delete" data-id="${id}">Excluir</button>
          </div>
        </div>
      </div>
    `;

    document.getElementById("accordionClientes").insertAdjacentHTML("beforeend", newAccordionItem);
    adicionarEventosExcluir();
  }

  // Evento de clique no botão de salvar cliente
  salvarClienteBtn.addEventListener("click", async function (event) {
  event.preventDefault();

  const formData = new FormData(form);

  try {
    const response = await fetch("/api/usuarios", {
      method: "POST",
      body: formData,
    });

    const responseData = await response.json();
    console.log("Resposta do servidor:", responseData); // Log da resposta

    if (!response.ok) {
      throw new Error(responseData.message || "Erro ao cadastrar cliente.");
    }

    alert("Cliente cadastrado com sucesso!");
    form.reset();
    carregarUsuarios(); // Atualiza a lista de usuários
  } catch (error) {
    console.error("Erro no cadastro:", error);
    alert(error.message);
  }
});

  // Função para excluir cliente
  function adicionarEventosExcluir() {
    document.querySelectorAll(".btn-delete").forEach((btn) => {
      btn.addEventListener("click", async function () {
        const id = this.getAttribute("data-id");

        try {
          const response = await fetch(`/api/usuarios/${id}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            throw new Error("Erro ao excluir cliente.");
          }

          carregarUsuarios();
        } catch (error) {
          console.error("Erro ao excluir:", error);
          alert("Erro ao excluir cliente.");
        }
      });
    });
  }

  // Carrega os clientes ao iniciar
  carregarUsuarios();
});


    
        // Adicionar eventos para exclusão de clientes
        function adicionarEventosExcluir() {
          document.querySelectorAll(".btn-delete").forEach((btn) => {
            btn.addEventListener("click", async function () {
              const id = this.getAttribute("data-id");
    
              try {
                const response = await fetch(`/api/usuarios/${id}`, {
                  method: "DELETE",
                });
    
                if (!response.ok) {
                  throw new Error("Erro ao excluir cliente.");
                }
    
                this.closest(".accordion-item").remove();
              } catch (error) {
                console.error("Erro ao excluir:", error);
                alert("Erro ao excluir cliente.");
              }
            });
          });
        }
    
        adicionarEventosExcluir();
      });
    </script>
    
    

  </body>
</html>
